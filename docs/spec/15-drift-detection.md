## Drift Detection & Prevention

North maintains strict source-of-truth semantics. The config is the source, generated files are artifacts. Drift happens when these diverge.

### Compatibility Declarations

```yaml
# north.config.yaml
compatibility:
  shadcn: "2.1.0"      # Track which shadcn version we're aligned with
  tailwind: "4.0.0"    # Track Tailwind version for feature compatibility
```

### Generated File Protection

Generated files include a header with checksum:

```css
/* 
 * GENERATED BY NORTH — DO NOT EDIT DIRECTLY
 * Source: north.config.yaml
 * Regenerate: north gen
 * Checksum: a3f8c2e9b1d4...
 * 
 * Manual edits will be overwritten and will cause drift warnings.
 */
```

### `north doctor` Drift Checks

```bash
north doctor
```

```
North Health Check
═══════════════════════════════════════════════════════════════

Config:
  ✓ north.config.yaml valid
  ✓ Extends chain resolves: @myorg/north-base → @north/base

Compatibility:
  ✓ shadcn 2.1.0 declared, tokens aligned
  ⚠️ shadcn 2.2.0 available — run `north upgrade --check` to see changes
  ✓ Tailwind 4.0 features supported

Generated Files:
  ✓ tokens/generated.css checksum matches
  ✗ tokens/effects.css was manually modified (line 47)
    → Run `north gen` to regenerate, or `north gen --force` to overwrite

Token Sync:
  ✓ All --color-* tokens have matching shadcn aliases
  ✓ No orphaned shadcn tokens detected

Index:
  ✓ .north/index.db is current (last updated: 2 minutes ago)
```

### `north scan` for New Components

When adding new shadcn components, scan for untracked tokens:

```bash
north scan components/ui/chart.tsx
```

```
Scanning: components/ui/chart.tsx
═══════════════════════════════════════════════════════════════

New tokens detected (not in North config):
  --chart-1    used on line 23
  --chart-2    used on line 24
  --chart-3    used on line 31

Options:
  north add-tokens chart-1 chart-2 chart-3 --from-shadcn
  north add-tokens chart-1 chart-2 chart-3 --values "#8884d8,#82ca9d,#ffc658"
```

### Git Hooks Integration

North provides hooks for lefthook, husky, or raw git hooks:

**lefthook.yml:**
```yaml
pre-commit:
  commands:
    north-check:
      glob: "*.{tsx,ts,css}"
      run: north check --staged
    north-drift:
      glob: "north/**/*"
      run: north doctor --fail-on-drift

pre-push:
  commands:
    north-strict:
      run: north check --strict
```

**package.json (husky):**
```json
{
  "scripts": {
    "prepare": "husky install"
  },
  "husky": {
    "hooks": {
      "pre-commit": "north check --staged && north doctor --fail-on-drift"
    }
  }
}
```

**Raw git hook (.git/hooks/pre-commit):**
```bash
#!/bin/sh
north check --staged || exit 1
north doctor --fail-on-drift || exit 1
```

### CI Integration

```yaml
# .github/workflows/north.yml
name: North Design System
on: [push, pull_request]

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Check for drift
        run: npx north doctor --fail-on-drift
      - name: Lint design system
        run: npx north check --strict
      - name: Verify generated files
        run: |
          npx north gen
          git diff --exit-code north/tokens/
```

The final `git diff --exit-code` catches the case where someone forgot to run `north gen` after changing the config.

**Note:** `npx north` works without installation. For faster CI, you can cache npm or add `north` as a devDependency.

### Drift Prevention Flow

```
┌─────────────────────────────────────────────────────────────┐
│  Developer changes north.config.yaml                        │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│  Runs `north gen` (or forgets to)                           │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│  Git commit triggers pre-commit hook                        │
│  → `north doctor --fail-on-drift`                           │
│  → Blocks commit if generated files are stale               │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│  PR triggers CI                                             │
│  → Regenerates and diffs                                    │
│  → Fails if any generated file would change                 │
└─────────────────────────────────────────────────────────────┘
```

Two gates, same check, drift can't sneak through.

